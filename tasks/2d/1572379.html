<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Balloon Toss</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f8ff; /* Alice Blue */
            font-family: 'Roboto Mono', monospace;
            color: #333;
        }

        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #0056b3;
            margin-bottom: 10px;
        }

        #canvas-container {
            position: relative;
            border: 2px solid #444;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            overflow: hidden; /* Ensures canvas corners are rounded */
            /* cursor: crosshair; */
        }

        #controls-container {
            margin-top: 20px;
            text-align: center;
        }

        #instructions {
            margin-top: 15px;
            font-size: 0.9em;
            color: #555;
            max-width: 600px;
            text-align: center;
        }

        label {
            font-weight: 700;
            color: #0056b3;
        }

        input[type=range] {
            width: 250px;
            cursor: pointer;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "p5": "https://cdn.jsdelivr.net/npm/p5@1.9.0/+esm"
            }
        }
    </script>
</head>

<body>
    <div id="game-container">
        <h1>Water Balloon Toss</h1>
        <div id="canvas-container">
            <!-- p5.js canvas will be inserted here -->
        </div>
        <div id="controls-container">
            <label for="currentSlider">Water Current Speed</label><br>
            <input type="range" id="currentSlider" min="1" max="6" value="2.5" step="0.5">
        </div>
        <div id="instructions">
            <p>Aim with your mouse and click to throw the balloon.<br>Try to hit the moving target!</p>
            <p>Based on angle and distance from the player, the trajectory and speed of the balloon are controlled.</p>
        </div>
    </div>

    <script type="module">
        import p5 from 'p5';

        const sketch = (p) => {
            // Game objects
            let balloon;
            let target;
            let particles = []; // For the splash effect

            // Game state
            let isThrown = false;
            let score = 0;
            let throwPower = 18;
            let throwAngle = 0

            // Environment
            let gravity;
            let waterLevel;
            let currentSpeed = 1.5;
            
            // Platform and Player properties will be initialized in setup
            let platform;
            let playerPos;

            // UI Elements
            let slider;

            // Balloon class representing the projectile
            class Balloon {
                constructor(x, y) {
                    this.pos = p.createVector(x, y);
                    this.vel = p.createVector(0, 0);
                    this.acc = p.createVector(0, 0);
                    this.r = 12;
                    this.color = p.color(255, 0, 0, 220);
                }

                // Apply a force (like gravity or the throw)
                applyForce(force) {
                    this.acc.add(force);
                }

                // Update balloon's position based on physics
                update() {
                    this.vel.add(this.acc);
                    this.pos.add(this.vel);
                    this.acc.mult(0); // Clear acceleration each frame
                }

                // Draw the balloon
                display() {
                    p.fill(this.color);
                    p.noStroke();
                    p.ellipse(this.pos.x, this.pos.y, this.r * 2);
                }

                // Check for collision with the target
                hits(target) {
                    let d = p.dist(this.pos.x, this.pos.y, target.pos.x, target.pos.y);
                    return (d < this.r + target.r);
                }

                // Check if the balloon is off the screen
                isOffscreen() {
                    return (this.pos.x < -this.r || this.pos.x > p.width + this.r || this.pos.y > p.height + this.r);
                }

                // Check if the balloon has hit the water
                isInWater() {
                    return this.pos.y > waterLevel + this.r;
                }
            }
            
            // Particle class for splash effects
            class Particle {
                constructor(x, y) {
                    this.pos = p.createVector(x, y);
                    this.vel = p5.Vector.random2D().mult(p.random(1, 4));
                    this.lifespan = 255;
                }

                update() {
                    this.vel.y += 0.1; // Particles are affected by gravity
                    this.pos.add(this.vel);
                    this.lifespan -= 5;
                }

                display() {
                    p.noStroke();
                    p.fill(50, 100, 200, this.lifespan);
                    p.ellipse(this.pos.x, this.pos.y, 8);
                }

                isFinished() {
                    return this.lifespan < 0;
                }
            }


            // Target class that floats on the water
            class Target {
                constructor(x, y) {
                    this.pos = p.createVector(x, y);
                    this.r = 25;
                    this.initialY = y;
                }

                // Update target's position based on water current and bobbing
                update(speed) {
                    this.pos.x += speed;
                    // Add a bobbing motion using a sine wave for a natural look
                    this.pos.y = this.initialY + p.sin(p.frameCount * 0.05) * 8;

                    // Wrap the target around the screen for continuous play
                    if (this.pos.x > p.width + this.r) {
                        this.pos.x = -this.r;
                    }
                    if (this.pos.x < -this.r) {
                        this.pos.x = p.width + this.r;
                    }
                }

                // Draw the target
                display() {
                    p.stroke(0);
                    p.strokeWeight(2);

                    // Main target body (yellow)
                    p.fill(255, 215, 0);
                    p.ellipse(this.pos.x, this.pos.y, this.r * 2);

                    // Bullseye (red)
                    p.fill(220, 20, 60);
                    p.noStroke();
                    p.ellipse(this.pos.x, this.pos.y, this.r);
                }
            }
            
            // Function to create a splash effect
            function createSplash(x, y, numParticles = 20) {
                 for (let i = 0; i < numParticles; i++) {
                    particles.push(new Particle(x, y));
                }
            }


            // p5.js setup function, runs once at the start
            p.setup = () => {
                const canvasContainer = document.getElementById('canvas-container');
                const canvas = p.createCanvas(800, 500);
                canvas.parent(canvasContainer);
                
                // Initialize platform and player positions
                platform = {
                    x: 40, // Platform is now further to the left
                    y: p.height / 2, 
                    width: 100,
                    height: 20
                };
                playerPos = {
                    x: platform.x + platform.width / 2, // Center player on platform
                    y: platform.y - 15,
                };

                waterLevel = p.height * 0.8;
                gravity = p.createVector(0, 0.25); // Set gravity force

                // Initialize game objects
                resetBalloon();
                target = new Target(p.width / 2, waterLevel - 10);
                
                // Get the slider from the HTML
                slider = document.getElementById('currentSlider');
            };

            // p5.js draw function, runs in a loop
            p.draw = () => {
                p.background(135, 206, 250); // Sky blue

                // Get current speed from the slider
                currentSpeed = parseFloat(slider.value);

                // Draw scene elements
                drawWater();
                drawPlatform();
                drawPlayer();

                // Update and display target
                target.update(currentSpeed);
                target.display();
                
                // Draw aiming line if not thrown
                if (!isThrown) {
                    drawAimingLine();
                }

                // Handle thrown balloon
                if (isThrown) {
                    balloon.applyForce(gravity);
                    balloon.update();

                    // Check for hit
                    if (balloon.hits(target)) {
                        score++;
                        createSplash(balloon.pos.x, balloon.pos.y, 30);
                        resetBalloon();
                    }
                    // Check for miss (hits water or goes offscreen)
                    else if (balloon.isInWater()) {
                        createSplash(balloon.pos.x, waterLevel);
                        resetBalloon();
                    } else if (balloon.isOffscreen()) {
                        resetBalloon();
                    }
                }
                
                // Display the balloon in its current state
                balloon.display();
                
                // Update and display splash particles
                for (let i = particles.length - 1; i >= 0; i--) {
                    particles[i].update();
                    particles[i].display();
                    if (particles[i].isFinished()) {
                        particles.splice(i, 1);
                    }
                }

                // Display score
                displayScore();
            };
            
            // p5.js mouse press handler
            p.mousePressed = () => {
                // Throw the balloon if it's ready and the click is within the canvas bounds
                if (!isThrown && p.mouseX > 0 && p.mouseX < p.width && p.mouseY > 0 && p.mouseY < p.height) {
                    isThrown = true;
                    // Calculate and constrain the launch angle
                    
                    let velocity = p5.Vector.fromAngle(throwAngle, throwPower);
                    balloon.applyForce(velocity);
                }
            };
            
            // Resets the balloon to its starting position
            function resetBalloon() {
                isThrown = false;
                balloon = new Balloon(playerPos.x, playerPos.y);
            }
            
            // Draws the visual elements of the water
            function drawWater() {
                // Base water color
                p.noStroke();
                p.fill(65, 105, 225, 200); // Royal Blue
                p.rect(0, waterLevel, p.width, p.height - waterLevel);

                // Animated waves on top
                p.fill(173, 216, 230, 150); // Light Blue
                let waveHeight = 10;
                p.beginShape();
                p.vertex(0, waterLevel);
                // Use Perlin noise for a more natural wave motion
                for (let x = 0; x <= p.width; x += 10) {
                    let y = waterLevel + p.map(p.noise(x * 0.02, p.frameCount * 0.02), 0, 1, -waveHeight, waveHeight);
                    p.vertex(x, y);
                }
                p.vertex(p.width, p.height);
                p.vertex(0, p.height);
                p.endShape(p.CLOSE);
            }
            
            // Draws the platform where the player stands
            function drawPlatform() {
                p.noStroke();
                // Draw the support structure for the platform
                p.fill(110, 70, 20); // Darker brown for the pole
                p.rect(platform.x + platform.width / 2 - 10, platform.y, 20, p.height - platform.y);
                
                // Draw the platform top
                p.fill(139, 69, 19); // Saddle Brown
                p.rect(platform.x, platform.y, platform.width, platform.height, 5);
            }
            
            // Draws a simple representation of the player
            function drawPlayer(){
                p.fill(50);
                p.noStroke();
                // Head
                p.ellipse(playerPos.x, playerPos.y - 10, 20, 20);
                // Body
                p.rect(playerPos.x - 10, playerPos.y, 20, 25, 5);
            }
            
            // Draws the aiming trajectory line
            function drawAimingLine() {
                // Calculate distance between player and mouse
                let distanceToMouse = p.dist(playerPos.x, playerPos.y, p.mouseX, p.mouseY);
                // Constrain line length between 0 and 250
                let lineLength = p.constrain(distanceToMouse, 0, 200);

                throwPower = p.map(lineLength,0,200,5,20)

                // Calculate the angle towards mouse
                let angle = p.atan2(p.mouseY - playerPos.y, p.mouseX - playerPos.x);
                let constrainedAngle = p.constrain(angle, -p.PI / 4, 0.2);

                throwAngle = constrainedAngle; // Update throw angle for balloon launch

                // Calculate end point using constrained length and angle
                let endX = playerPos.x + lineLength * p.cos(constrainedAngle);
                let endY = playerPos.y + lineLength * p.sin(constrainedAngle);

                p.stroke(255, 0, 0, 150);
                p.strokeWeight(3);
                p.drawingContext.setLineDash([10, 10]);
                p.line(playerPos.x, playerPos.y, endX, endY);
                p.drawingContext.setLineDash([]);

                // Draw crosshair at end point
                const crosshairSize = 10;
                p.stroke(255, 0, 0);
                p.strokeWeight(2);
                // Horizontal line
                p.line(endX - crosshairSize, endY, endX + crosshairSize, endY);
                // Vertical line
                p.line(endX, endY - crosshairSize, endX, endY + crosshairSize);
                // Center dot
                p.noStroke();
                p.fill(255, 0, 0);
                p.ellipse(endX, endY, 4);
            }
            
            // Displays the score on the screen
            function displayScore() {
                p.fill(255);
                p.stroke(0);
                p.strokeWeight(3);
                p.textSize(32);
                p.textAlign(p.LEFT, p.TOP);
                p.text(`Score: ${score}`, 20, 20);
            }
        };
        
        // Create the p5 instance
        const container = window.document.getElementById('game-container');
        new p5(sketch, container);
    </script>
</body>

</html>
