<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floor Vibration Simulation</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
        }

        #main-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }

        #simulation-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #canvas-container {
            border: 1px solid #ccc;
        }

        #info-card {
            width: 250px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #controls {
            margin: 15px 0;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }
    </style>
    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "p5": "https://cdn.jsdelivr.net/npm/p5@1.9.4/+esm"
            }
        }
    </script>
</head>

<body>
    <div id="main-container">
        <div id="simulation-container">
            <div id="canvas-container"></div>
            <div id="controls">
                <button id="walk-btn">Walk</button>
                <button id="run-btn">Run</button>
                <button id="reset-btn">Reset</button>
            </div>
            <div>Creak Intensity: <span id="intensity-value">0</span></div>
        </div>
        <div id="info-card">
            <h3>How it works:</h3>
            <p>• Creak intensity is calculated based on the vertical velocity of the plank under the figure.</p>
            <p>• The impact visualization (yellow circle) grows with higher intensity.</p>
            <p>• Floor vibration is simulated as a wave that spreads from the figure and weakens with distance.</p>
        </div>
    </div>
    <script type="module">
        import p5 from 'p5';

        // Main variables
        let floorWidth = 800;
        let floorDepth = 300;
        let plankCount = 30;
        let plankWidth = floorWidth / plankCount;
        let personX = 0;
        let isWalking = false;
        let isRunning = false;
        let planks = [];
        let damping = 0.98;
        let personVel = 0;
        let personSpeed = 2;
        let intensityValue = 0;
        let intensityDisplay = document.getElementById('intensity-value');
        let controls = {
            walk: document.getElementById('walk-btn'),
            run: document.getElementById('run-btn'),
            reset: document.getElementById('reset-btn')
        };

        // p5.js sketch
        new p5((p) => {
            p.setup = function () {
                let canvas = p.createCanvas(floorWidth, floorDepth);
                canvas.parent('canvas-container');

                // Initialize planks
                for (let i = 0; i < plankCount; i++) {
                    planks.push({
                        x: i * plankWidth,
                        y: 0,
                        vel: 0,
                        amp: 0,
                        phase: p.random(p.TWO_PI)
                    });
                }

                // Set up controls
                controls.walk.addEventListener('click', () => {
                    isWalking = true;
                    isRunning = false;
                });

                controls.run.addEventListener('click', () => {
                    isWalking = false;
                    isRunning = true;
                });

                controls.reset.addEventListener('click', () => {
                    resetSimulation();
                });
            };

            p.draw = function () {
                p.background(240);
                updatePersonPosition();
                updatePlanks();
                drawFloor();
                drawPerson();
                calculateIntensity();
            };

            function resetSimulation() {
                personX = 0;
                isWalking = false;
                isRunning = false;
                for (let plank of planks) {
                    plank.y = 0;
                    plank.vel = 0;
                    plank.amp = 0;
                }
            }

            function updatePersonPosition() {
                if (isWalking || isRunning) {
                    personVel = isRunning ? 4 : 2;
                    personX += personVel;

                    if (personX > p.width) {
                        personX = 0;
                        isWalking = false;
                        isRunning = false;
                    }
                }
            }

            function updatePlanks() {
                for (let i = 0; i < planks.length; i++) {
                    let plank = planks[i];
                    let distance = p.abs(personX - plank.x - plankWidth / 2);
                    let influence = p.max(0, 1 - distance / 200);

                    // Add vibration when figure is near
                    if (influence > 0) {
                        let amplitude = isRunning ? 8 : 4;
                        plank.amp = amplitude * influence;
                        plank.phase += 0.2;
                    }

                    // Update plank position
                    plank.vel += plank.amp * p.sin(plank.phase);
                    plank.vel *= damping;
                    plank.y += plank.vel;
                }
            }

            function drawFloor() {
                p.noStroke();
                for (let i = 0; i < planks.length; i++) {
                    let plank = planks[i];
                    p.fill(139, 69, 19);
                    p.rect(plank.x, p.height / 2 + plank.y, plankWidth, p.height);
                }
            }

            function drawPerson() {
                let currentPlank = getCurrentPlank();
                if (!currentPlank) return;

                // Body
                p.stroke(0);
                p.strokeWeight(2);
                p.line(personX, currentPlank.y, personX, currentPlank.y - 40);

                // Head
                p.fill(255, 205, 148);
                p.ellipse(personX, currentPlank.y - 50, 20, 20);

                // Arms
                p.line(personX - 15, currentPlank.y - 30, personX + 15, currentPlank.y - 30);

                // Legs
                p.line(personX, currentPlank.y, personX - 10, currentPlank.y + 30);
                p.line(personX, currentPlank.y, personX + 10, currentPlank.y + 30);

                // Impact effect
                if (isWalking || isRunning) {
                    let intensity = p.abs(getCurrentPlankVelocity());
                    p.fill(255, 255, 0, 150);
                    p.noStroke();
                    p.ellipse(personX, currentPlank.y, intensity * 20, intensity * 20);
                }
            }

            function getCurrentPlank() {
                let plankIndex = p.floor(personX / plankWidth);
                if (plankIndex >= 0 && plankIndex < planks.length) {
                    return planks[plankIndex];
                }
                return null;
            }

            function getCurrentPlankVelocity() {
                let plank = getCurrentPlank();
                return plank ? plank.vel : 0;
            }

            function calculateIntensity() {
                intensityValue = p.abs(getCurrentPlankVelocity()).toFixed(2);
                intensityDisplay.textContent = intensityValue;
            }
        });
    </script>
</body>

</html>
