<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curveball Simulation</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        #canvas-container {
            display: flex;
            justify-content: center;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        label {
            width: 120px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "p5": "https://cdn.skypack.dev/p5@1.4.0"
            }
        }
    </script>
</head>
<body>
    <h1>Curveball Simulation</h1>
    <div id="canvas-container"></div>
    <div class="controls">
        <div class="control-group">
            <label for="spin">Spin Rate (rpm):</label>
            <input type="range" id="spin" min="0" max="3000" value="1500" step="100">
            <span id="spin-value">1500</span>
        </div>
        <div class="control-group">
            <label for="velocity">Velocity (mph):</label>
            <input type="range" id="velocity" min="40" max="100" value="75" step="5">
            <span id="velocity-value">75</span>
        </div>
        <div class="control-group">
            <label for="angle">Launch Angle (Â°):</label>
            <input type="range" id="angle" min="0" max="20" value="10" step="1">
            <span id="angle-value">10</span>
        </div>
        <button id="pitch-button">Pitch Ball</button>
    </div>

    <script type="module">
        import p5 from 'p5';

        // Constants for the simulation
        const WIDTH = 700;
        const HEIGHT = 500;
        const GRAVITY = 0.003; // Reduced gravity to match original simulation
        const DRAG_COEFFICIENT = 0.003; // Reduced drag to match original simulation
        const MAGNUS_COEFFICIENT = 0.00004; // Adjusted to match original curve
        const BALL_RADIUS = 20;
        const INITIAL_X = 75;
        const INITIAL_Y = 150;
        
        // Conversion factors
        const MPH_TO_PPS = 1.46667; // miles per hour to pixels per second
        const RPM_TO_RPS = 1/60; // revolutions per minute to revolutions per second

        // Create a new p5 instance
        new p5((sketch) => {
            // Variables for the simulation
            let ball;
            let trajectory = [];
            let spin = 1500; // RPM
            let velocity = 75; // MPH
            let angle = 10; // degrees
            
            // UI elements
            let spinSlider, velocitySlider, angleSlider;
            let spinValue, velocityValue, angleValue;
            let pitchButton;
            
            // Game state
            let isPitching = false;
            let isGameOver = false;
            let strikeCount = 0;
            let ballCount = 0;
            
            // Baseball seams pattern
            const seamPoints = [
                {x: 0, y: -0.3}, {x: 0.3, y: 0}, {x: 0, y: 0.3}, {x: -0.3, y: 0}
            ];

            // Ball class
            class Ball {
                constructor(x, y, vx, vy, spin) {
                    this.x = x;
                    this.y = y;
                    this.vx = vx;
                    this.vy = vy;
                    this.spin = spin * RPM_TO_RPS; // Convert RPM to RPS
                    this.radius = BALL_RADIUS;
                    this.coefficientOfRestitution = 0.5;
                }

                update() {
                    if (!isPitching) return;
                    
                    // Calculate Magnus force coefficients
                    let magnusCoefficient = MAGNUS_COEFFICIENT * this.spin;
                    
                    // Magnus effect (lateral force due to spin)
                    let magnusX = magnusCoefficient * this.vy;
                    let magnusY = -magnusCoefficient * this.vx;
                    
                    // Apply forces
                    this.vx += magnusX;
                    this.vy += magnusY + GRAVITY;
                    
                    // Apply drag
                    let speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                    let dragForce = DRAG_COEFFICIENT * speed * speed;
                    let dragX = -dragForce * (this.vx / speed);
                    let dragY = -dragForce * (this.vy / speed);
                    
                    this.vx += dragX;
                    this.vy += dragY;
                    
                    // Update position
                    this.x += this.vx;
                    this.y += this.vy;
                    
                    // Add to trajectory
                    trajectory.push({x: this.x, y: this.y});
                    
                    // Check for strike or ball
                    this.checkStrikeOrBall();
                    
                    // Stop conditions
                    if (this.x > WIDTH - 50 || this.y > HEIGHT - 20 || speed < 0.1) {
                        isPitching = false;
                        if (!isGameOver) {
                            ballCount++;
                            if (ballCount >= 4) {
                                isGameOver = true;
                            }
                        }
                    }
                }

                checkStrikeOrBall() {
                    // Check if the ball is in the strike zone
                    const strikeZoneLeft = WIDTH * 0.35;
                    const strikeZoneRight = WIDTH * 0.65;
                    const strikeZoneTop = HEIGHT * 0.3;
                    const strikeZoneBottom = HEIGHT * 0.6;
                    
                    // Check if ball is in strike zone horizontally
                    const inStrikeZoneX = this.x >= strikeZoneLeft && this.x <= strikeZoneRight;
                    
                    // Check if ball is in strike zone vertically
                    const inStrikeZoneY = this.y >= strikeZoneTop && this.y <= strikeZoneBottom;
                    
                    // Check if ball is within the strike zone
                    if (inStrikeZoneX && inStrikeZoneY) {
                        // Ball is in the strike zone
                        if (this.vx < 0.5 && this.vx > -0.5 && 
                            this.vy < 0.5 && this.vy > -0.5) {
                            // Ball has stopped in the strike zone - strike!
                            isPitching = false;
                            strikeCount++;
                            if (strikeCount >= 3) {
                                isGameOver = true;
                            }
                        }
                    }
                }

                display() {
                    // Draw the baseball seams
                    sketch.push();
                    sketch.translate(this.x, this.y);
                    sketch.noFill();
                    sketch.stroke(0);
                    sketch.strokeWeight(1);
                    
                    // Draw the four-seam pattern
                    sketch.beginShape();
                    for (let point of seamPoints) {
                        sketch.vertex(point.x * this.radius, point.y * this.radius);
                    }
                    sketch.endShape(sketch.CLOSE);
                    
                    // Draw the baseball
                    sketch.fill(255);
                    sketch.strokeWeight(0.5);
                    sketch.ellipse(0, 0, this.radius * 2);
                    
                    sketch.pop();
                }
            }

            // Setup the sketch
            sketch.setup = function() {
                const canvas = sketch.createCanvas(WIDTH, HEIGHT);
                canvas.parent('canvas-container');
                
                // Initialize UI elements
                spinSlider = document.getElementById('spin');
                velocitySlider = document.getElementById('velocity');
                angleSlider = document.getElementById('angle');
                
                spinValue = document.getElementById('spin-value');
                velocityValue = document.getElementById('velocity-value');
                angleValue = document.getElementById('angle-value');
                
                pitchButton = document.getElementById('pitch-button');
                
                // Add event listeners
                spinSlider.addEventListener('input', updateSpin);
                velocitySlider.addEventListener('input', updateVelocity);
                angleSlider.addEventListener('input', updateAngle);
                pitchButton.addEventListener('click', pitchBall);
                
                // Initial setup
                resetGame();
            };

            // Update spin value
            function updateSpin() {
                spin = parseInt(spinSlider.value);
                spinValue.textContent = spin;
            }

            // Update velocity value
            function updateVelocity() {
                velocity = parseInt(velocitySlider.value);
                velocityValue.textContent = velocity;
            }

            // Update angle value
            function updateAngle() {
                angle = parseInt(angleSlider.value);
                angleValue.textContent = angle;
            }

            // Reset the game state
            function resetGame() {
                isPitching = false;
                isGameOver = false;
                strikeCount = 0;
                ballCount = 0;
                trajectory = [];
            }

            // Start a new pitch
            function pitchBall() {
                if (isGameOver) {
                    resetGame();
                }
                
                if (!isPitching) {
                    // Convert velocity from mph to pixels per second
                    let initialVelocity = velocity * MPH_TO_PPS;
                    
                    // Calculate initial velocity components
                    let vx = -initialVelocity * Math.cos(sketch.radians(angle));
                    let vy = -initialVelocity * Math.sin(sketch.radians(angle));
                    
                    // Create new ball
                    ball = new Ball(INITIAL_X, INITIAL_Y, vx, vy, spin);
                    
                    // Reset trajectory
                    trajectory = [{x: INITIAL_X, y: INITIAL_Y}];
                    
                    // Start pitching
                    isPitching = true;
                }
            }

            // Draw the sketch
            sketch.draw = function() {
                // Draw background
                sketch.background(220);
                
                // Draw pitcher and catcher
                sketch.fill(100);
                sketch.noStroke();
                sketch.rect(0, HEIGHT - 60, 60, 60); // Pitcher
                sketch.rect(WIDTH - 60, HEIGHT - 80, 60, 80); // Catcher
                
                // Draw strike zone
                sketch.stroke(255, 0, 0);
                sketch.strokeWeight(2);
                sketch.noFill();
                sketch.rect(WIDTH * 0.35, HEIGHT * 0.3, WIDTH * 0.3, HEIGHT * 0.3);
                
                // Draw trajectory
                sketch.stroke(0);
                sketch.strokeWeight(2);
                sketch.noFill();
                sketch.beginShape();
                for (let point of trajectory) {
                    sketch.vertex(point.x, point.y);
                }
                sketch.endShape();
                
                // Update and display ball
                if (isPitching && ball) {
                    ball.update();
                    ball.display();
                }
                
                // Draw UI information
                sketch.fill(0);
                sketch.noStroke();
                sketch.textSize(16);
                sketch.text(`Strike: ${strikeCount}`, 20, 30);
                sketch.text(`Ball: ${ballCount}`, 20, 60);
                
                // Draw game over message
                if (isGameOver) {
                    sketch.fill(255, 0, 0);
                    sketch.textSize(32);
                    sketch.textAlign(sketch.CENTER);
                    if (strikeCount >= 3) {
                        sketch.text("Strikeout!", WIDTH/2, HEIGHT/2);
                    } else {
                        sketch.text("Walk!", WIDTH/2, HEIGHT/2);
                    }
                }
            };
        }, 'canvas-container');
    </script>
</body>
</html>