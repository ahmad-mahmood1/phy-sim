<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bamboo Simulation</title>

    <script type="importmap">
        {
          "imports": {
            "p5": "https://cdn.jsdelivr.net/npm/p5@1.9.0/+esm"
          }
        }
      </script>
</head>

<body>
    <script type="module">
        import p5 from 'p5';

        new p5((sketch) => {
            let segments = [];
            let growthTimer = 0;
            let wind = 0;
            let rainfall = 0;
            let sliderWind;
            let sliderRain;
            let resetButton;

            class Segment {
                constructor(x, y, len) {
                    this.x = x;
                    this.y = y;
                    this.len = len;
                    this.angle = 0;
                    this.angularVelocity = 0;
                    this.angularAcceleration = 0;
                    this.mass = 1;
                }

                applyForce(force) {
                    let torque = force * this.len;
                    this.angularAcceleration += torque / this.mass;
                }

                update() {
                    this.angularVelocity += this.angularAcceleration;
                    this.angle += this.angularVelocity;
                    this.angularAcceleration = 0;
                }

                display() {
                    sketch.push();
                    sketch.translate(this.x, this.y);
                    sketch.rotate(this.angle);
                    sketch.stroke(76, 153, 0);
                    sketch.strokeWeight(4);
                    sketch.line(0, 0, 0, -this.len);
                    sketch.pop();
                }
            }

            sketch.setup = function () {
                sketch.createCanvas(800, 600);
                segments.push(new Segment(sketch.width / 2, sketch.height, 100));
                sliderWind = sketch.createSlider(0, 10, 0);
                sliderWind.position(20, 20);
                sliderRain = sketch.createSlider(0, 10, 0);
                sliderRain.position(20, 50);
                resetButton = sketch.createButton('Reset');
                resetButton.position(20, 80);
                resetButton.mousePressed(reset);
            }

            sketch.draw = function () {
                sketch.background(240);
                wind = sliderWind.value();
                rainfall = sliderRain.value();
                sketch.fill(0);
                sketch.text(`Wind: ${wind}`, 160, 35);
                sketch.text(`Rainfall: ${rainfall}`, 160, 65);

                if (sketch.frameCount % 180 === 0 && segments.length < 10) {
                    let lastSegment = segments[segments.length - 1];
                    segments.push(new Segment(lastSegment.x, lastSegment.y - lastSegment.len, 80));
                }

                let baseSegment = segments[0];
                baseSegment.applyForce(wind);

                for (let i = 1; i < segments.length; i++) {
                    let segment = segments[i];
                    segment.applyForce(wind);
                    segment.applyForce(rainfall * 0.5);
                    segment.mass = 1 + rainfall * 0.1;
                    segment.update();
                }

                for (let i = segments.length - 1; i >= 0; i--) {
                    let segment = segments[i];
                    segment.display();
                }
            }

            function reset() {
                segments = [];
                segments.push(new Segment(sketch.width / 2, sketch.height, 100));
                sliderWind.value(0);
                sliderRain.value(0);
            }
        });
    </script>
</body>

</html>