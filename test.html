<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flocking Birds Simulation</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    canvas {
      display: block;
      margin: 0 auto;
      /* centers the canvas horizontally */
    }

    #info {
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: center;
      color: white;
      font-family: Arial, sans-serif;
    }
  </style>

  <!-- Import map shim for browsers without native support -->
  <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>

  <!-- Define all external dependencies in the import map -->
  <script type="importmap">
        {
            "imports": {
                "p5": "https://esm.sh/p5@1.9.3"
            }
        }
    </script>
</head>

<body>
  <div id="info">Flocking Birds Simulation - Click to move predator</div>
  <script type="module">
    import p5 from 'p5';

    new p5((sketch) => {
      // Define the Bird class
      class Bird {
        constructor(x, y) {
          this.position = sketch.createVector(x, y);
          this.velocity = sketch.createVector(sketch.random(-1, 1), sketch.random(-1, 1));
          this.velocity.setMag(sketch.random(2, 4));
          this.acceleration = sketch.createVector();
          this.maxForce = 0.2;
          this.maxSpeed = 4;
        }

        edges() {
          if (this.position.x > sketch.width) {
            this.position.x = 0;
          } else if (this.position.x < 0) {
            this.position.x = sketch.width;
          }
          if (this.position.y > sketch.height) {
            this.position.y = 0;
          } else if (this.position.y < 0) {
            this.position.y = sketch.height;
          }
        }

        align(birds) {
          let perceptionRadius = 50;
          let steering = sketch.createVector();
          let total = 0;
          for (let other of birds) {
            let d = sketch.dist(
              this.position.x,
              this.position.y,
              other.position.x,
              other.position.y
            );
            if (other !== this && d < perceptionRadius) {
              steering.add(other.velocity);
              total++;
            }
          }
          if (total > 0) {
            steering.div(total);
            steering.setMag(this.maxSpeed);
            steering.sub(this.velocity);
            steering.limit(this.maxForce);
          }
          return steering;
        }

        cohesion(birds) {
          let perceptionRadius = 50;
          let steering = sketch.createVector();
          let total = 0;
          for (let other of birds) {
            let d = sketch.dist(
              this.position.x,
              this.position.y,
              other.position.x,
              other.position.y
            );
            if (other !== this && d < perceptionRadius) {
              steering.add(other.position);
              total++;
            }
          }
          if (total > 0) {
            steering.div(total);
            steering.sub(this.position);
            steering.setMag(this.maxSpeed);
            steering.sub(this.velocity);
            steering.limit(this.maxForce);
          }
          return steering;
        }

        separation(birds) {
          let perceptionRadius = 50;
          let steering = sketch.createVector();
          let total = 0;
          for (let other of birds) {
            let d = sketch.dist(
              this.position.x,
              this.position.y,
              other.position.x,
              other.position.y
            );
            if (other !== this && d < perceptionRadius) {
              let diff = sketch.createVector(
                this.position.x - other.position.x,
                this.position.y - other.position.y
              );
              diff.div(d);
              steering.add(diff);
              total++;
            }
          }
          if (total > 0) {
            steering.div(total);
            steering.setMag(this.maxSpeed);
            steering.sub(this.velocity);
            steering.limit(this.maxForce);
          }
          return steering;
        }

        flee(predator) {
          let perceptionRadius = 100;
          let steering = sketch.createVector();
          let d = sketch.dist(
            this.position.x,
            this.position.y,
            predator.position.x,
            predator.position.y
          );
          if (d < perceptionRadius) {
            let diff = sketch.createVector(
              this.position.x - predator.position.x,
              this.position.y - predator.position.y
            );
            diff.div(d);
            steering.add(diff);
            steering.setMag(this.maxSpeed);
            steering.sub(this.velocity);
            steering.limit(this.maxForce);
          }
          return steering;
        }

        update() {
          this.position.add(this.velocity);
          this.velocity.add(this.acceleration);
          this.velocity.limit(this.maxSpeed);
          this.acceleration.mult(0);
        }

        applyForce(force) {
          this.acceleration.add(force);
        }

        flock(birds, predator) {
          let alignment = this.align(birds);
          let cohesion = this.cohesion(birds);
          let separation = this.separation(birds);
          let fleeing = this.flee(predator);

          alignment.mult(1.0);
          cohesion.mult(1.0);
          separation.mult(1.5);
          fleeing.mult(2.0);

          this.applyForce(alignment);
          this.applyForce(cohesion);
          this.applyForce(separation);
          this.applyForce(fleeing);
        }

        show() {
          sketch.stroke(255);
          sketch.strokeWeight(2);
          sketch.fill(255, 100);
          sketch.ellipse(this.position.x, this.position.y, 10, 10);
        }
      }

      // Define the Predator class
      class Predator {
        constructor(x, y) {
          this.position = sketch.createVector(x, y);
        }

        show() {
          sketch.stroke(255, 0, 0);
          sketch.strokeWeight(2);
          sketch.fill(255, 0, 0);
          sketch.ellipse(this.position.x, this.position.y, 20, 20);
        }
      }

      // Sketch variables
      let birds = [];
      let predator;

      sketch.setup = () => {
        sketch.createCanvas(800, 600);
        for (let i = 0; i < 100; i++) {
          birds.push(new Bird(sketch.random(sketch.width), sketch.random(sketch.height)));
        }
        predator = new Predator(sketch.width / 2, sketch.height / 2);
      };

      sketch.draw = () => {
        sketch.background(0);
        for (let bird of birds) {
          bird.edges();
          bird.flock(birds, predator);
          bird.update();
          bird.show();
        }
        predator.show();
      };

      sketch.mousePressed = () => {
        predator.position.x = sketch.mouseX;
        predator.position.y = sketch.mouseY;
      };
    });
  </script>
</body>

</html>