<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Tremor Simulation</title>
    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "p5": "https://cdn.jsdelivr.net/npm/p5@1.9.0/+esm"
        }
    }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f0f0f0;
        }

        #canvas-container {
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        button.active {
            background-color: #2e7d32;
        }

        #instructions {
            max-width: 600px;
            text-align: center;
            margin-bottom: 20px;
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div id="instructions">
        <p>Click on the tremor level buttons to change the intensity of the hand tremor.
            The pen will draw the word "hello" with the selected tremor effect.</p>
        <p>Note: The simulation might take a few seconds to start, and may sometimes appear jittery or frozen.
            This is due to the performance-intensive nature of the Perlin noise simulation.
            If the animation appears stuck, try restarting it or adjusting the tremor level.</p>
    </div>

    <div id="canvas-container"></div>
    <div id="controls">
        <button id="low">Low Tremor</button>
        <button id="medium">Medium Tremor</button>
        <button id="high">High Tremor</button>
        <button id="restart">Restart Animation</button>
    </div>

    <script type="module">
        import p5 from 'p5';

        // p5.js sketch using instance mode
        const sketch = (p) => {
            // --- Configuration ---
            const LETTER_SPACING = 30; // Space between letters
            const BASE_Y = 200; // Baseline Y position
            const PEN_LENGTH = 20; // Visual length of the pen
            const PEN_HEAD_SIZE = 5; // Size of the pen tip
            const ANIMATION_DURATION = 200; // Frames for full animation
            const TRAIL_OPACITY = 50; // Trail opacity (0-255)
            const PATH_POINTS = {
                // Predefined points for "hello" (Each sub-array is a letter)
                h: [[0, 0], [0, -40], [0, -20], [15, -20], [15, 0]],
                e: [[0, 0], [15, 0], [15, -20], [0, -20], [15, -30]],
                l: [[0, 0], [0, -40], [0, -20], [15, -20]],
                o: [[7.5, -10], [15, -20], [0, -20], [7.5, -30], [7.5, -10]]
            };

            // --- State Variables ---
            let currentTremor = { amplitude: 8, frequency: 0.05 }; // Default: Medium
            let currentLetterIndex = 0; // Index of current letter in "hello"
            let currentPointIndex = 0; // Index within current letter's path
            let animationProgress = 0; // Progress through current path segment (0-1)
            let frameCounter = 0; // Counts frames for animation timing
            let isAnimating = true; // True if animation is running
            let trailPoints = []; // Stores {x, y, age} for trail effect
            let currentTremorLevel = 'medium'; // Track active tremor level button
            let letters; // Array of letters with x offsets

            // --- p5.js Setup ---
            p.setup = () => {
                const canvas = p.createCanvas(600, 300);
                canvas.parent('canvas-container');

                // Pre-calculate cumulative X offsets for each letter in "hello"
                letters = "hello".split('').map((char, i) => {
                    const prevLetters = "hello".slice(0, i); // Letters before current one
                    const cumulativeSpacing = prevLetters.length * LETTER_SPACING;
                    return { char, xOffset: cumulativeSpacing };
                });

                // Setup event listeners for buttons
                document.getElementById('low').addEventListener('click', () => setTremorLevel('low'));
                document.getElementById('medium').addEventListener('click', () => setTremorLevel('medium'));
                document.getElementById('high').addEventListener('click', () => setTremorLevel('high'));
                document.getElementById('restart').addEventListener('click', restartAnimation);

                setTremorLevel('medium'); // Set initial tremor and activate button
            };

            // --- p5.js Draw Loop ---
            p.draw = () => {
                p.background(255); // White background

                // Draw coordinate grid (optional, for visual reference)
                drawGrid();

                // Update and draw trail effect
                updateTrail();
                drawTrail();

                // Animate pen movement if active
                if (isAnimating) {
                    animatePen();
                }

                // Draw the pen icon at its current position
                const { x, y } = getCurrentPenPosition();
                drawPen(x, y);
            };

            // --- Animation Logic ---
            /**
             * Animates the pen drawing the current letter.
             * Moves along path points, applies tremor, updates trail.
             */
            function animatePen() {
                frameCounter++;

                // Calculate animation progress (0-1) based on frame counter
                animationProgress = p.min(frameCounter / ANIMATION_DURATION, 1);

                // Get interpolated position along current path segment
                let { x, y } = getCurrentPenPosition();

                // Apply tremor offset to the pen position
                const tremorOffset = getTremorOffset();
                x += tremorOffset.x;
                y += tremorOffset.y;

                // Add current position to trail for visualization
                trailPoints.push({ x, y, age: 0 });

                // Check if current segment is complete
                if (animationProgress >= 1) {
                    // Advance to next point in the current letter's path
                    currentPointIndex++;

                    // Check if current letter is complete
                    if (currentPointIndex >= getCurrentLetterPoints().length - 1) {
                        // Advance to next letter or stop animation
                        currentLetterIndex++;
                        currentPointIndex = 0;
                        frameCounter = 0;

                        if (currentLetterIndex >= letters.length) {
                            isAnimating = false; // Stop animation when all letters are drawn
                            console.log("Animation complete!");
                        }
                    } else {
                        // Reset progress for next segment
                        frameCounter = 0;
                    }
                }
            }

            /**
             * Returns the interpolated (x, y) position of the pen along the current path segment.
             * @returns {{x: number, y: number}} The interpolated position.
             */
            function getCurrentPenPosition() {
                const letter = letters[currentLetterIndex];
                const points = getCurrentLetterPoints();
                const currentPoint = points[currentPointIndex];
                const nextPoint = points[currentPointIndex + 1];

                // Interpolate between current and next point based on animation progress
                const x = letter.xOffset + p.lerp(currentPoint[0], nextPoint[0], animationProgress);
                const y = BASE_Y + p.lerp(currentPoint[1], nextPoint[1], animationProgress);

                return { x, y };
            }

            /**
             * Returns the array of points defining the path for the current letter.
             * @returns {number[][]} Array of [x, y] coordinates.
             */
            function getCurrentLetterPoints() {
                const letter = letters[currentLetterIndex];
                return PATH_POINTS[letter.char];
            }

            // --- Tremor Simulation ---
            let noiseOffsetX = 0; // Offset for Perlin noise in X direction
            let noiseOffsetY = 1000; // Offset for Perlin noise in Y direction (different from X)

            /**
             * Generates a tremor offset using Perlin noise.
             * @returns {{x: number, y: number}} The tremor offset.
             */
            function getTremorOffset() {
                // Generate smooth, continuous noise values based on frequency and amplitude
                const nx = p.noise(noiseOffsetX) * 2 - 1; // Normalize noise to [-1, 1]
                const ny = p.noise(noiseOffsetY) * 2 - 1;

                // Increment noise offsets based on frequency for continuous motion
                noiseOffsetX += currentTremor.frequency;
                noiseOffsetY += currentTremor.frequency;

                // Scale noise by amplitude to control tremor intensity
                return { x: nx * currentTremor.amplitude, y: ny * currentTremor.amplitude };
            }

            // --- Visuals ---
            /**
             * Draws a simple pen icon at the specified (x, y) position.
             * @param {number} x - The x-coordinate.
             * @param {number} y - The y-coordinate.
             */
            function drawPen(x, y) {
                p.push(); // Save current drawing style and coordinate system
                p.translate(x, y); // Move origin to pen tip

                // Draw pen body (line from tip to base)
                p.stroke(0);
                p.strokeWeight(2);
                p.line(0, 0, 0, PEN_LENGTH);

                // Draw pen tip (small circle)
                p.fill(0);
                p.noFill();
                p.ellipse(0, 0, PEN_HEAD_SIZE * 2);
                p.pop(); // Restore drawing style and coordinate system
            }

            /**
             * Draws a coordinate grid for visual reference.
             */
            function drawGrid() {
                p.stroke(200); // Light gray grid lines
                p.strokeWeight(1);

                // Draw vertical grid lines
                for (let x = 0; x < p.width; x += 50) {
                    p.line(x, 0, x, p.height);
                }

                // Draw horizontal grid lines
                for (let y = 0; y < p.height; y += 50) {
                    p.line(0, y, p.width, y);
                }

                // Draw axes (thicker black lines)
                p.stroke(0);
                p.strokeWeight(2);
                p.line(0, BASE_Y, p.width, BASE_Y); // Horizontal axis (baseline)
                p.line(p.width / 2, 0, p.width / 2, p.height); // Vertical axis (center)
            }

            /**
             * Updates the age of each point in the trail and removes old points.
             */
            function updateTrail() {
                // Increment age of each point
                for (let i = trailPoints.length - 1; i >= 0; i--) {
                    trailPoints[i].age++;

                    // Remove points older than a threshold (e.g., 50 frames)
                    if (trailPoints[i].age > 50) {
                        trailPoints.splice(i, 1);
                    }
                }
            }

            /**
             * Draws the trail of points left by the pen.
             */
            function drawTrail() {
                // Draw a fading trail behind the pen
                p.noFill();
                p.beginShape(); // Start drawing a polyline

                // Draw line segments connecting trail points
                for (let i = 0; i < trailPoints.length - 1; i++) {
                    const p1 = trailPoints[i];
                    const p2 = trailPoints[i + 1];

                    // Calculate opacity based on point age (newer points are more opaque)
                    const opacity = p.map(p1.age, 0, 50, TRAIL_OPACITY, 0);
                    p.stroke(0, opacity);

                    // Draw line segment between consecutive points
                    p.line(p1.x, p1.y, p2.x, p2.y);
                }
                p.endShape(); // Finish drawing the polyline
            }


            // --- Controls ---
            /**
             * Sets the tremor level and updates the button state.
             * @param {string} level - The tremor level ("low", "medium", or "high").
             */
            function setTremorLevel(level) {
                // Reset animation state and noise offsets
                restartAnimation();

                // Update current tremor settings based on selected level
                switch (level) {
                    case 'low':
                        currentTremor = { amplitude: 8, frequency: 0.03 };
                        break;
                    case 'medium':
                        currentTremor = { amplitude: 12, frequency: 0.05 };
                        break;
                    case 'high':
                        currentTremor = { amplitude: 16, frequency: 0.07 };
                        break;
                    default:
                        console.error("Invalid tremor level:", level);
                        return;
                }

                // Update active button state
                currentTremorLevel = level;
                updateButtonState();
            }

            /**
             * Restarts the animation from the beginning.
             */
            function restartAnimation() {
                currentLetterIndex = 0;
                currentPointIndex = 0;
                animationProgress = 0;
                frameCounter = 0;
                isAnimating = true;
                trailPoints = [];
                noiseOffsetX = 0; // Reset noise offsets
                noiseOffsetY = 1000;
            }

            /**
             * Updates the visual state of the tremor level buttons.
             */
            function updateButtonState() {
                // Remove "active" class from all buttons
                document.querySelectorAll('#controls button').forEach(btn => btn.classList.remove('active'));

                // Add "active" class to the button matching the current tremor level
                document.getElementById(currentTremorLevel).classList.add('active');
            }
        };

        // Initialize p5.js instance
        new p5(sketch);
    </script>
</body>

</html>
